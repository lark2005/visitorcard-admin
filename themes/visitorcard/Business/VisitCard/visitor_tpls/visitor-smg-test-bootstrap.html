<!DOCTYPE html>
<html>
<head>
    <tc_include file="Public:head-vc" />
	<title>
		{$cardSetting.card_title}-{$cardSetting.page1_title}
	</title>
	<link rel="apple-touch-icon" href="{$cardSetting.shortcut}">
	<link rel="shortcut icon" href="{$cardSetting.shortcut}">
</head>
<body style="max-width: 720px;margin:0 auto;">
<div class="main">
    <form role="form" method="post" id="form1"  action="{:leuu('business/visitCard/visitorSave')}">
        <input type="hidden" name="card_id" value ="{$cardSetting.id}">
        <input type="hidden" name="card_title" value ="{$cardSetting.card_title}">
		<if condition="!empty($cardSetting['banner_url'])">
            <!-- 轮播广告 -->
            <div id="owl-demo" class="owl-carousel owl-theme" style="opacity: 1; display: block;">
                <img src="{$cardSetting.banner_url}" style="width:100%">
            </div>
		</if>
		<if condition="empty($cardSetting['banner_url']) && !empty($cardSetting['page1_title'])">
            <header class="mui-bar mui-bar-nav">
                <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
                <h1 class="mui-title" style="text-align:center;width:100%;">{$cardSetting.page1_title}</h1>
            </header>
		</if>


        <div id="page">
            <div id="page_reg" class="pagemode" style="z-index: 2;">
                <div id="reg_outer" style="margin-top: 0;">

                    <div class="form-group" >
                        <input class="form-control" name="company" id="company" placeholder="*{$cardSetting.filed_company_desc}" maxlength="40" type="text"></div>
                    <div class="form-group" >
                        <input  class="form-control" name="name" id="name" placeholder="*{$cardSetting.filed_name_desc}" maxlength="20" type="text"></div>
                    <div class="form-group" >
                        <input  class="form-control" name="position" id="position" placeholder="*{$cardSetting.filed_position_desc}" maxlength="20" type="text"></div>


                    <div class="form-group row" >
                        <input type="hidden" name="country" id = "country" value ="">
                        <input type="hidden" name="province" id = "province" value ="">
                        <input type="hidden" name="city" id = "city" value ="">
                        <div class="col-xs-4" style="padding-right: 3px">
                            <select id="S1" name="S1" class="form-control" >
                            </select>
                        </div>
                        <div class="col-xs-4" style="padding: 0">
                            <select id="S2" name="S2" class="form-control" >
                                <option value="" selected="selected">-请选择-</option>
                            </select>
                        </div>
                        <div class="col-xs-4" style="padding-left: 3px">
                            <select id="S3" name="S3" class="form-control">
                                <option value="" selected="selected">-请选择-</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" >
                        <input class="form-control" name="mobile" id="mobile" placeholder="*请输入手机号码" maxlength="11" type="text">
                    </div>
                    <div class="form-group row" >
                        <div class="col-xs-4" >
                        <input class="form-control" type="text" id="vcode" name="vcode" placeholder="验证码" value="" onfocus="this.value=''" onblur="if(this.value=='')this.value=''"/>
                        </div>
                        <div class="col-xs-8" >
                            <label style="padding: 5px;background-color: #d7d7d7;" id="msg_send_button" title="发送验证码" >发送验证码</label>
                        </div>
                    </div>
                    <input id="hidCountryFlag" value="" type="hidden">
                    <div style="margin-top: 1em; font-size: 12px; margin-left: 5%; color: #FF0000">
                        重要信息，请认真填写。
                    </div>
                    <div class="form-group ">
                            <input class="btn btn-primary form-control" type="submit" name="linkBtn" value="下一步" onclick="return checkform();" id="linkBtn">
                    </div>

                </div>
            </div>
        </div>

    </form>
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">提示</h4>
            </div>
            <div class="modal-body" ><label id="alertModalMessage">在这里添加一些文本</label></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<tc_include file="Public:scripts-vc" />
<script language="javascript" type="text/javascript">
    $(document).ready(function () {
        select1();
        //select1();
        $('#S1').change("change", select2);
        $('#S2').change("change", select3);
        $.ajaxSetup({
            async: false
        });

        $("#msg_send_button").click(function(){
            if(sendMsgCode()){
                time(this);
            }

        });


    });

    // 倒计时间
    var wait=0;
    function time(o){
        if (wait==60) {
            o.removeAttribute("disabled");
            o.innerHTML="发送验证码";
            o.style.backgroundColor="#fe9900";
            wait=0;
        }else{
            o.setAttribute("disabled", true);
            o.innerHTML= (59-wait)+"秒后重新获取";
            o.style.backgroundColor="#8f8b8b";
            wait++;
            setTimeout(function(){
                time(o)
            },1000)
        }
    }

    // 校验手机号
    function checkMobile(isFocus) {
        var userTel = document.getElementById("mobile").value.trim();
        if (userTel == '' && isFocus!=0) {
            alert('请输入手机号码');
            document.getElementById("mobile").focus();
            return false;
        }
        var userCountry = document.getElementById("country").value.trim();
        var reg = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
        var regMobileOther = /^[0-9]{6,11}$/;

        if (userCountry == "中国") {
            if (reg.test(userTel)) {
                return true;
            } else {
                alert("请输入正确的手机号码");
                document.getElementById("mobile").focus();
                return false;
            }
        }
        else if (userCountry != "中国") {
            if (regMobileOther.test(userTel)) {
                return true;
            } else {
                alert("请输入正确的手机号码");
                document.getElementById("mobile").focus();
                return false;
            };
        }

        return false;
    }

    // 发送验证码
    function sendMsgCode(){
        var userTel = document.getElementById("mobile").value.trim();
        if (!checkMobile(0)) {
            return false;
        }

        // 判断是否可发送
        if (wait==0) {
            $.ajaxSettings.async = false;
            // 发送验证码
            $.post("{:leuu('business/visitCard/sendMsgCode')}", {'mobile':userTel},function(json){
                var res = eval("("+json+")");// 将json转换为对象 json 格式
                if (res.code=="0") {
                    alert('发送成功'+res.message);
                } else {
                    alert('发送失败'+res.message);
                }
            });
            $.ajaxSettings.async = true;
            return true;
        }else{
            return false;
        }
    }
    // 校验表单
    function checkform() {

        var company = document.getElementById("company").value.trim();
        if (company == '') {
            alert('{$cardSetting.filed_company_desc}');
            document.getElementById("company").focus();
            return false;
        }

        var position = document.getElementById("position").value.trim();
        if (position == '') {
            alert('{$cardSetting.filed_position_desc}');
            document.getElementById("position").focus();
            return false;
        }

        var name = document.getElementById("name").value.trim();
        if (name == '') {
            alert('{$cardSetting.filed_name_desc}');
            document.getElementById("name").focus();
            return false;
        }

        var userProvince = document.getElementById("S2").value.trim();
        if (userProvince == '') {
            alert('请选择省份');
            document.getElementById("S2").focus();
            return false;
        }

        var userCity = document.getElementById("S3").value.trim();
        if (userCity == '') {
            alert('请选择城市');
            document.getElementById("S3").focus();
            return false;
        }

        var userTel = document.getElementById("mobile").value.trim();
        if (!checkMobile()) {
            return false;
        }

        $("#country").val($("#S1 option:selected").text());
        $("#province").val($("#S2 option:selected").text());
        $("#city").val($("#S3 option:selected").text());


        var vcode = document.getElementById("vcode").value.trim();
        if (vcode == '') {
            alert('请输入手机验证码');
            document.getElementById("vcode").focus();
            return false;
        }

        $.ajaxSettings.async = false;
        var checkMsgCode;
        $.ajax({
            url : "{:leuu('business/visitCard/checkMsgCode')}",
            async : false, // 注意此处需要同步，因为返回完数据后，下面才能让结果的第一条selected
            type : "POST",
            data:{'mobile':userTel,'vcode':vcode},
            dataType : "json",
            success : function(res) {
                //alert("1=" + res);
                checkMsgCode = res;
            }
        });

        if (checkMsgCode.code == "0") {
            return true;
        }else{
            alert(checkMsgCode.message);
            document.getElementById("vcode").focus();
            return false;
        }

        $.ajaxSettings.async = true;
    }

    function select1() {
        $.ajax(
                {
                    type: "post",
                    url: "__WEB_ROOT__/index.php?g=api&m=cityArea&a=getJson",
                    data: { "parent": "0","type": "0"},
                    success: function (msg) {
                        var areas = eval(msg);
                        for (var i = 0; i < areas.length; i++) {
                            $("#S1").append("<option value=" + areas[i].area_id + ">" + areas[i].name + "</option>");
                        }

                        select2();
                    }
                })
    };

    function select2() {
        $("#S2").html("");
        $("#S2").append("<option value=\"\"> 请选择 </option>");
        $.ajax(
                {
                    type: "post",
                    url: "__WEB_ROOT__/index.php?g=api&m=cityArea&a=getJson",
                    data: { "type": "1", "parent": $('#S1').val() },
                    success: function (msg) {
                        var areas = eval(msg);
                        for (var i = 0; i < areas.length; i++) {
                            $("#S2").append("<option value=" + areas[i].area_id + ">" + areas[i].name + "</option>");
                        }
                        select3();
                    }
                })
    };

    function select3() {
        $("#S3").html("");
        $("#S3").append("<option value=\"\"> 请选择 </option>");

        // 判断省份有没有
        if($('#S2').val()){
            $.ajax(
                    {
                        type: "post",
                        url: "__WEB_ROOT__/index.php?g=api&m=cityArea&a=getJson",
                        data: { "type": "2", "parent": $('#S2').val() },
                        success: function (msg) {
                            var areas = eval(msg);
                            for (var i = 0; i < areas.length; i++) {
                                $("#S3").append("<option value=" + areas[i].area_id + ">" + areas[i].name + "</option>");
                            }
                        }
                    })
        }
    };
</script>

</body></html>